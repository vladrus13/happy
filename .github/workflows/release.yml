name: Create Release Tag

on:
    workflow_dispatch:
        inputs:
            version:
                description: 'Version tag (e.g. v1.0.0)'
                required: true
                type: string

permissions:
    contents: write

jobs:
    create-tag:
        runs-on: ubuntu-latest
        timeout-minutes: 5
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Validate version and check for existing tag
              run: |
                  VERSION="${{ github.event.inputs.version }}"
                  if ! echo "$VERSION" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
                      echo "::error::Invalid version format '$VERSION'. Expected format: v1.0.0"
                      exit 1
                  fi
                  echo "VERSION=$VERSION" >> "$GITHUB_ENV"

                  if git ls-remote --tags origin "$VERSION" | grep -q "$VERSION"; then
                      echo "::error::Tag '$VERSION' already exists on remote"
                      exit 1
                  fi

            - name: Configure git identity
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Create and push tag
              run: |
                  git tag -a "$VERSION" -m "Release $VERSION"
                  git push origin "$VERSION"

            - name: Write step summary
              run: |
                  echo "## Release Tag Created" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
                  echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Tag | \`$VERSION\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Commit | \`${{ github.sha }}\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "Downstream workflows \`build-desktop.yml\` and \`build-server.yml\` have been triggered." >> "$GITHUB_STEP_SUMMARY"
