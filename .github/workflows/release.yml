name: Release

on:
    workflow_dispatch:
        inputs:
            version:
                description: 'Version tag (e.g. v1.0.0)'
                required: true
                type: string

permissions:
    contents: write

jobs:
    create-tag:
        runs-on: ubuntu-latest
        timeout-minutes: 5
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Validate version and check for existing tag
              run: |
                  VERSION="${{ github.event.inputs.version }}"
                  if ! echo "$VERSION" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
                      echo "::error::Invalid version format '$VERSION'. Expected format: v1.0.0"
                      exit 1
                  fi
                  echo "VERSION=$VERSION" >> "$GITHUB_ENV"

                  if git ls-remote --tags origin "$VERSION" | grep -q "$VERSION"; then
                      echo "::error::Tag '$VERSION' already exists on remote"
                      exit 1
                  fi

            - name: Configure git identity
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Create and push tag
              run: |
                  git tag -a "$VERSION" -m "Release $VERSION"
                  git push origin "$VERSION"

            - name: Write step summary
              run: |
                  echo "## Release Tag Created" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
                  echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Tag | \`$VERSION\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Commit | \`${{ github.sha }}\` |" >> "$GITHUB_STEP_SUMMARY"

    create-release:
        needs: create-tag
        runs-on: ubuntu-latest
        timeout-minutes: 5
        outputs:
            release-id: ${{ steps.create-release.outputs.id }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.inputs.version }}

            - name: Create draft GitHub Release
              id: create-release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ github.event.inputs.version }}
                  draft: true
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    build-tauri:
        needs: create-release
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: macos
                      runner: macos-latest
                      rust-targets: aarch64-apple-darwin,x86_64-apple-darwin
                      tauri-args: --target universal-apple-darwin
                    - platform: windows
                      runner: windows-latest
                      rust-targets: x86_64-pc-windows-msvc
                      tauri-args: ''
                    - platform: linux
                      runner: ubuntu-22.04
                      rust-targets: x86_64-unknown-linux-gnu
                      tauri-args: ''
        runs-on: ${{ matrix.runner }}
        timeout-minutes: 60
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.inputs.version }}

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: yarn

            - name: Setup Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.rust-targets }}

            - name: Cache Rust build artifacts
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: packages/happy-app/src-tauri -> target

            - name: Install Linux system dependencies
              if: matrix.platform == 'linux'
              run: sudo apt-get update && sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

            - name: Install Node dependencies
              env:
                  SKIP_HAPPY_WIRE_BUILD: '1'
              run: yarn install --frozen-lockfile --ignore-engines

            - name: Build happy-wire
              run: yarn workspace @slopus/happy-wire build

            - name: Build and upload Tauri app
              uses: tauri-apps/tauri-action@v0
              with:
                  releaseId: ${{ needs.create-release.outputs.release-id }}
                  projectPath: packages/happy-app
                  tauriScript: yarn tauri
                  args: ${{ matrix.tauri-args }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Write step summary
              shell: bash
              run: |
                  echo "## Desktop Build Complete (${{ matrix.platform }})" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
                  echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Platform | \`${{ matrix.platform }}\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Runner | \`${{ matrix.runner }}\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Tag | \`${{ github.event.inputs.version }}\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "Artifacts have been uploaded to the draft GitHub Release." >> "$GITHUB_STEP_SUMMARY"

    build-server:
        needs: create-tag
        runs-on: ubuntu-latest
        timeout-minutes: 30
        steps:
            - name: Validate required secrets
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_ACCESS_SECRET_KEY_ID: ${{ secrets.AWS_ACCESS_SECRET_KEY_ID }}
                  AWS_REGION: ${{ secrets.AWS_REGION }}
                  AWS_ECR_REPOSITORY: ${{ secrets.AWS_ECR_REPOSITORY }}
              run: |
                  missing=()
                  [ -z "$AWS_ACCESS_KEY_ID" ] && missing+=("AWS_ACCESS_KEY_ID")
                  [ -z "$AWS_ACCESS_SECRET_KEY_ID" ] && missing+=("AWS_ACCESS_SECRET_KEY_ID")
                  [ -z "$AWS_REGION" ] && missing+=("AWS_REGION")
                  [ -z "$AWS_ECR_REPOSITORY" ] && missing+=("AWS_ECR_REPOSITORY")
                  if [ ${#missing[@]} -gt 0 ]; then
                      echo "::error::Missing required secrets: ${missing[*]}"
                      exit 1
                  fi

            - name: Checkout
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.inputs.version }}

            - name: Derive version tag
              run: |
                  GIT_TAG="${{ github.event.inputs.version }}"
                  VERSION_TAG="${GIT_TAG#v}"
                  echo "GIT_TAG=$GIT_TAG" >> "$GITHUB_ENV"
                  echo "VERSION_TAG=$VERSION_TAG" >> "$GITHUB_ENV"

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_ACCESS_SECRET_KEY_ID }}
                  aws-region: ${{ secrets.AWS_REGION }}

            - name: Login to Amazon ECR
              id: ecr-login
              uses: aws-actions/amazon-ecr-login@v2

            - name: Build Docker image
              env:
                  ECR_REGISTRY: ${{ steps.ecr-login.outputs.registry }}
                  ECR_REPO: ${{ secrets.AWS_ECR_REPOSITORY }}
              run: |
                  IMAGE_BASE="$ECR_REGISTRY/$ECR_REPO"
                  docker build \
                      --file Dockerfile.server \
                      --tag "$IMAGE_BASE:$VERSION_TAG" \
                      --tag "$IMAGE_BASE:latest" \
                      --label "org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}" \
                      --label "org.opencontainers.image.revision=${{ github.sha }}" \
                      --label "org.opencontainers.image.version=$VERSION_TAG" \
                      .
                  echo "IMAGE_BASE=$IMAGE_BASE" >> "$GITHUB_ENV"

            - name: Push Docker image to ECR
              run: |
                  docker push "$IMAGE_BASE:$VERSION_TAG"
                  docker push "$IMAGE_BASE:latest"

            - name: Write step summary
              run: |
                  echo "## Server Image Pushed to ECR" >> "$GITHUB_STEP_SUMMARY"
                  echo "" >> "$GITHUB_STEP_SUMMARY"
                  echo "| Tag | URI |" >> "$GITHUB_STEP_SUMMARY"
                  echo "|-----|-----|" >> "$GITHUB_STEP_SUMMARY"
                  echo "| \`$VERSION_TAG\` | \`$IMAGE_BASE:$VERSION_TAG\` |" >> "$GITHUB_STEP_SUMMARY"
                  echo "| \`latest\` | \`$IMAGE_BASE:latest\` |" >> "$GITHUB_STEP_SUMMARY"
